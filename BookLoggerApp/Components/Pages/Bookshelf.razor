@page "/"
@page "/bookshelf"
@using BookLoggerApp.Core.ViewModels
@using BookLoggerApp.Core.Models
@using BookLoggerApp.Core.Enums
@using BookLoggerApp.Components.Shared
@inject BookshelfViewModel ViewModel
@inject Microsoft.AspNetCore.Components.NavigationManager Navigation

<PageTitle>Bookshelf - BookLogger</PageTitle>

<div class="bookshelf-container">
    <!-- Header & Controls -->
    <div class="bookshelf-header">
        <h1>ðŸ“š My Bookshelf</h1>
        <div class="bookshelf-controls">
            <input type="text" class="search-input" placeholder="ðŸ” Search books..."
                   @bind="ViewModel.SearchQuery" @bind:event="oninput" @onchange="HandleSearch" />
            <button class="btn btn-primary" @onclick="NavigateToAddBook">+ Add Book</button>
        </div>
    </div>

    <!-- Filters & Sort -->
    <div class="bookshelf-filters">
        <div class="filter-group">
            <label>Sort by:</label>
            <select value="@ViewModel.SortBy" @onchange="@((ChangeEventArgs e) => { ViewModel.SortBy = e.Value?.ToString() ?? "Title"; HandleSearch(); })">
                <option value="Title">Title</option>
                <option value="Author">Author</option>
                <option value="DateAdded">Date Added</option>
                <option value="Status">Status</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Status:</label>
            <select value="@(ViewModel.FilterStatus?.ToString() ?? "")" @onchange="@((ChangeEventArgs e) => { var val = e.Value?.ToString(); ViewModel.FilterStatus = string.IsNullOrEmpty(val) ? null : Enum.Parse<ReadingStatus>(val); HandleSearch(); })">
                <option value="">All</option>
                <option value="@ReadingStatus.Planned">Planned</option>
                <option value="@ReadingStatus.Reading">Reading</option>
                <option value="@ReadingStatus.Completed">Completed</option>
                <option value="@ReadingStatus.Abandoned">Abandoned</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Genre:</label>
            <select value="@(ViewModel.FilterGenreId?.ToString() ?? "")" @onchange="@((ChangeEventArgs e) => { var val = e.Value?.ToString(); ViewModel.FilterGenreId = string.IsNullOrEmpty(val) ? null : Guid.Parse(val); HandleSearch(); })">
                <option value="">All Genres</option>
                @foreach (var genre in ViewModel.Genres)
                {
                    <option value="@genre.Id">@genre.Icon @genre.Name</option>
                }
            </select>
        </div>

        <button class="btn btn-secondary" @onclick="HandleClearFilters">Clear Filters</button>
    </div>

    <!-- Book Grid -->
    @if (ViewModel.IsBusy)
    {
        <div class="loading">Loading your books...</div>
    }
    else if (!ViewModel.Books.Any() && !ViewModel.BookshelfPlants.Any())
    {
        <div class="empty-state">
            <h2>No books found</h2>
            <p>Start building your library by adding your first book!</p>
            <button class="btn btn-primary" @onclick="NavigateToAddBook">+ Add Your First Book</button>
        </div>
    }
    else
    {
        <div class="book-grid">
            @{
                var booksPerShelf = 8;
                
                // Combine books and plants into shelf slots
                var allItems = new List<object>();
                allItems.AddRange(ViewModel.Books);
                
                // Add plants at their positions
                foreach (var plant in ViewModel.BookshelfPlants.OrderBy(p => p.BookshelfPosition))
                {
                    allItems.Add(plant);
                }

                var shelves = allItems
                    .Select((item, index) => new { item, index })
                    .GroupBy(x => x.index / booksPerShelf)
                    .Select(g => g.Select(x => x.item).ToList())
                    .ToList();
            }

            @foreach (var (shelf, shelfIndex) in shelves.Select((s, i) => (s, i)))
            {
                <div class="shelf-row">
                    @foreach (var item in shelf)
                    {
                        @if (item is Book book)
                        {
                            <BookCard Book="@book"
                                      OnClick="() => HandleBookClick(book)"
                                      OnDelete="() => HandleDeleteBook(book.Id)" />
                        }
                        else if (item is UserPlant plant)
                        {
                            <PlantCard Plant="@plant"
                                       IsInBookshelf="true"
                                       OnClick="() => HandlePlantClick(plant)"
                                       OnRemove="() => HandleRemovePlant(plant.Id)" />
                        }
                    }
                    <!-- Add plant slot at end of each shelf -->
                    @if (shelf.Count < booksPerShelf && ViewModel.AvailablePlants.Any())
                    {
                        <div class="empty-slot" @onclick="() => HandleAddPlant(shelfIndex)">
                            <div class="empty-slot-icon">ðŸŒ±</div>
                            <div class="empty-slot-text">Add Plant</div>
                        </div>
                    }
                </div>
            }
        </div>

        <div class="bookshelf-footer">
            <p>Showing @ViewModel.Books.Count book(s) and @ViewModel.BookshelfPlants.Count plant(s) across @shelves.Count shelf/shelves</p>
        </div>
    }
</div>

<!-- Quick Reading Timer -->
<QuickReadingTimer Book="@selectedBook"
                   IsVisible="@showQuickTimer"
                   OnClose="HandleCloseQuickTimer"
                   OnSessionSaved="HandleSessionSaved" />

<!-- Plant Selection Modal -->
@if (showPlantSelector)
{
    <div class="purchase-modal-overlay" @onclick="ClosePlantSelector">
        <div class="purchase-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>ðŸŒ± Place Plant on Shelf</h2>
                <button class="btn-close" @onclick="ClosePlantSelector">Ã—</button>
            </div>

            <div class="modal-body">
                @if (!ViewModel.AvailablePlants.Any())
                {
                    <p>No plants available. Purchase plants from the <a href="/shop">Plant Shop</a> first!</p>
                }
                else
                {
                    <p>Select a plant to place on shelf @(selectedShelfIndex + 1):</p>
                    <div class="plant-selection-grid">
                        @foreach (var plant in ViewModel.AvailablePlants)
                        {
                            <div class="plant-selection-card" @onclick="() => SelectPlantForPlacement(plant.Id)">
                                <div class="plant-preview" style="@GetPlantPreviewStyle(plant)">
                                    <div class="status-badge">@GetPlantStatusIcon(plant.Status)</div>
                                </div>
                                <h4>@plant.Name</h4>
                                <p class="plant-species">@plant.Species.Name</p>
                                <p class="plant-level-mini">Level @plant.CurrentLevel</p>
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="ClosePlantSelector">Cancel</button>
            </div>
        </div>
    </div>
}

@code {
    private Book? selectedBook;
    private bool showQuickTimer;
    private bool showPlantSelector;
    private int selectedShelfIndex;

    protected override async Task OnInitializedAsync()
    {
        await ViewModel.LoadCommand.ExecuteAsync(null);
    }

    private void HandleSearch()
    {
        ViewModel.SearchCommand.ExecuteAsync(null);
    }

    private async Task HandleClearFilters()
    {
        ViewModel.ClearFiltersCommand.Execute(null);
        await ViewModel.LoadCommand.ExecuteAsync(null);
    }

    private async Task HandleDeleteBook(Guid bookId)
    {
        // TODO: Add confirmation dialog
        await ViewModel.DeleteBookCommand.ExecuteAsync(bookId);
    }

    private void HandleBookClick(Book book)
    {
        // Show quick timer or navigate to detail based on user preference
        // For now, show quick timer for reading books, navigate for others
        if (book.Status == ReadingStatus.Reading || book.Status == ReadingStatus.Planned)
        {
            selectedBook = book;
            showQuickTimer = true;
        }
        else
        {
            NavigateToBookDetail(book.Id);
        }
    }

    private void NavigateToBookDetail(Guid bookId)
    {
        Navigation.NavigateTo($"/books/{bookId}");
    }

    private void NavigateToAddBook()
    {
        Navigation.NavigateTo("/books/new");
    }

    private void HandleCloseQuickTimer()
    {
        showQuickTimer = false;
        selectedBook = null;
    }

    private async Task HandleSessionSaved()
    {
        // Refresh the bookshelf to show updated progress
        await ViewModel.LoadCommand.ExecuteAsync(null);
        showQuickTimer = false;
        selectedBook = null;
    }

    // Plant-specific methods
    private void HandleAddPlant(int shelfIndex)
    {
        selectedShelfIndex = shelfIndex;
        showPlantSelector = true;
    }

    private void HandlePlantClick(UserPlant plant)
    {
        // Navigate to plant detail or show plant info
        // For now, just show the plant widget
        Navigation.NavigateTo($"/dashboard");
    }

    private async Task HandleRemovePlant(Guid plantId)
    {
        await ViewModel.RemovePlantFromBookshelfCommand.ExecuteAsync(plantId);
    }

    private async Task SelectPlantForPlacement(Guid plantId)
    {
        var position = $"{selectedShelfIndex}:end";
        await ViewModel.PlacePlantInBookshelfCommand.ExecuteAsync((plantId, position));
        showPlantSelector = false;
    }

    private void ClosePlantSelector()
    {
        showPlantSelector = false;
    }

    private string GetPlantPreviewStyle(UserPlant plant)
    {
        var hash = plant.SpeciesId.GetHashCode();
        var colors = new[]
        {
            ("8B4513", "A0522D"), // Terra cotta
            ("6B4423", "7D5530"), // Clay brown
            ("4A7C59", "5C8E6B"), // Green pot
            ("5D4E6D", "6F5F7F"), // Purple pot
            ("8B7355", "A68968"), // Gold pot
        };

        var colorIndex = Math.Abs(hash) % colors.Length;
        var (dark, light) = colors[colorIndex];

        return $"background: linear-gradient(to bottom, #{light}, #{dark}); padding: 2rem; border-radius: 8px;";
    }

    private string GetPlantStatusIcon(PlantStatus status)
    {
        return status switch
        {
            PlantStatus.Healthy => "ðŸ˜Š",
            PlantStatus.Thirsty => "ðŸ˜°",
            PlantStatus.Wilting => "ðŸ˜µ",
            PlantStatus.Dead => "ðŸ’€",
            _ => "ðŸŒ±"
        };
    }
}

