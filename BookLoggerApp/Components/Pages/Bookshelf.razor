@page "/"
@page "/bookshelf"
@using BookLoggerApp.Core.ViewModels
@using BookLoggerApp.Core.Models
@using BookLoggerApp.Core.Enums
@using BookLoggerApp.Components.Shared
@inject BookshelfViewModel ViewModel
@inject Microsoft.AspNetCore.Components.NavigationManager Navigation

<PageTitle>Bookshelf - BookLogger</PageTitle>

<div class="bookshelf-container">
    <!-- Reading Goal Header -->
    <GoalHeader TbrCount="@ViewModel.TbrCount"
                GoalTarget="@ViewModel.GoalTarget"
                BooksRead="@ViewModel.BooksReadThisYear"
                BooksRemaining="@ViewModel.BooksRemainingToGoal" />

    <!-- Header & Controls -->
    <div class="bookshelf-header">
        <h1>ðŸ“š My Bookshelf</h1>
        <div class="bookshelf-controls">
            <input type="text" class="search-input" placeholder="ðŸ” Search books..."
                   @bind="ViewModel.SearchQuery" @bind:event="oninput" @onchange="HandleSearch" />
            <button class="btn btn-primary" @onclick="NavigateToAddBook">+ Add Book</button>
        </div>
    </div>

    <!-- Filters & Sort -->
    <div class="bookshelf-filters">
        <div class="filter-group">
            <label>Sort by:</label>
            <select value="@ViewModel.SortBy" @onchange="@((ChangeEventArgs e) => { ViewModel.SortBy = e.Value?.ToString() ?? "Title"; HandleSearch(); })">
                <option value="Title">Title</option>
                <option value="Author">Author</option>
                <option value="DateAdded">Date Added</option>
                <option value="Status">Status</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Status:</label>
            <select value="@(ViewModel.FilterStatus?.ToString() ?? "")" @onchange="@((ChangeEventArgs e) => { var val = e.Value?.ToString(); ViewModel.FilterStatus = string.IsNullOrEmpty(val) ? null : Enum.Parse<ReadingStatus>(val); HandleSearch(); })">
                <option value="">All</option>
                <option value="@ReadingStatus.Planned">Planned</option>
                <option value="@ReadingStatus.Reading">Reading</option>
                <option value="@ReadingStatus.Completed">Completed</option>
                <option value="@ReadingStatus.Abandoned">Abandoned</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Genre:</label>
            <select value="@(ViewModel.FilterGenreId?.ToString() ?? "")" @onchange="@((ChangeEventArgs e) => { var val = e.Value?.ToString(); ViewModel.FilterGenreId = string.IsNullOrEmpty(val) ? null : Guid.Parse(val); HandleSearch(); })">
                <option value="">All Genres</option>
                @foreach (var genre in ViewModel.Genres)
                {
                    <option value="@genre.Id">@genre.Icon @genre.Name</option>
                }
            </select>
        </div>

        <button class="btn btn-secondary" @onclick="HandleClearFilters">Clear Filters</button>
    </div>

    <!-- Book Grid -->
    @if (ViewModel.IsBusy)
    {
        <div class="loading">Loading your books...</div>
    }
    else if (!ViewModel.Books.Any() && !ViewModel.BookshelfPlants.Any())
    {
        <div class="empty-state">
            <h2>No books found</h2>
            <p>Start building your library by adding your first book!</p>
            <button class="btn btn-primary" @onclick="NavigateToAddBook">+ Add Your First Book</button>
        </div>
    }
    else
    {
        <div class="book-grid">
            @{
                var booksPerShelf = 8;

                // Create a combined list of books and plants
                var allItems = new List<object>();

                // Add all books first
                allItems.AddRange(ViewModel.Books);

                // Add all plants - they appear after books
                allItems.AddRange(ViewModel.BookshelfPlants);

                var sortedItems = allItems;

                var shelves = sortedItems
                    .Select((item, index) => new { item, index })
                    .GroupBy(x => x.index / booksPerShelf)
                    .Select(g => g.Select(x => x.item).ToList())
                    .ToList();
            }

            @foreach (var (shelf, shelfIndex) in shelves.Select((s, i) => (s, i)))
            {
                <div class="shelf-row">
                    @foreach (var (item, slotIndex) in shelf.Select((item, idx) => (item, idx)))
                    {
                        var globalPosition = shelfIndex * booksPerShelf + slotIndex;

                        @if (item is Book book)
                        {
                            <div class="shelf-slot" @ondrop="() => HandleDropOnSlot(globalPosition)"
                                 @ondragover:preventDefault="true" @ondragover="() => {}">
                                <BookCard Book="@book"
                                          IsInBookshelf="true"
                                          IsDraggable="true"
                                          OnClick="() => HandleBookClick(book)"
                                          OnDragStart="() => HandleDragStartBook(book.Id)"
                                          OnDelete="() => HandleDeleteBook(book.Id)" />
                            </div>
                        }
                        else if (item is UserPlant plant)
                        {
                            <div class="shelf-slot"
                                 @ondrop="() => HandleDropOnSlot(globalPosition)"
                                 @ondragover:preventDefault="true" @ondragover="() => {}">
                                <PlantCard Plant="@plant"
                                           IsInBookshelf="true"
                                           IsDraggable="true"
                                           OnClick="() => HandlePlantClick(plant)"
                                           OnDragStart="() => HandleDragStart(plant.Id)"
                                           OnRemove="() => HandleRemovePlant(plant.Id)" />
                            </div>
                        }
                    }
                    <!-- Add plant slot at end of each shelf -->
                    @if (shelf.Count < booksPerShelf && ViewModel.AvailablePlants.Any())
                    {
                        var globalPosition = shelfIndex * booksPerShelf + shelf.Count;
                        <div class="empty-slot" @onclick="() => HandleAddPlant(globalPosition)"
                             @ondrop="() => HandleDropOnSlot(globalPosition)"
                             @ondragover:preventDefault="true" @ondragover="() => {}">
                            <div class="empty-slot-icon">ðŸŒ±</div>
                            <div class="empty-slot-text">Add Plant</div>
                        </div>
                    }
                </div>
            }
        </div>

        <div class="bookshelf-footer">
            <p>Showing @ViewModel.Books.Count book(s) and @ViewModel.BookshelfPlants.Count plant(s) across @shelves.Count shelf/shelves</p>
        </div>
    }
</div>

<!-- Quick Reading Timer -->
<QuickReadingTimer Book="@selectedBook"
                   IsVisible="@showQuickTimer"
                   OnClose="HandleCloseQuickTimer"
                   OnSessionSaved="HandleSessionSaved" />

<!-- Plant Selection Modal -->
@if (showPlantSelector)
{
    <div class="purchase-modal-overlay" @onclick="ClosePlantSelector">
        <div class="purchase-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>ðŸŒ± Place Plant on Shelf</h2>
                <button class="btn-close" @onclick="ClosePlantSelector">Ã—</button>
            </div>

            <div class="modal-body">
                @if (!ViewModel.AvailablePlants.Any())
                {
                    <p>No plants available. Purchase plants from the <a href="/shop">Plant Shop</a> first!</p>
                }
                else
                {
                    <p>Select a plant to place at position @selectedPosition:</p>
                    <div class="plant-selection-grid">
                        @foreach (var plant in ViewModel.AvailablePlants)
                        {
                            <div class="plant-selection-card" @onclick="() => SelectPlantForPlacement(plant.Id)">
                                <div class="plant-preview" style="@GetPlantPreviewStyle(plant)">
                                    <img src="@plant.Species.ImagePath" alt="@plant.Species.Name" class="plant-selection-image" />
                                    <div class="status-badge">@GetPlantStatusIcon(plant.Status)</div>
                                </div>
                                <h4>@plant.Name</h4>
                                <p class="plant-species">@plant.Species.Name</p>
                                <p class="plant-level-mini">Level @plant.CurrentLevel</p>
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="ClosePlantSelector">Cancel</button>
            </div>
        </div>
    </div>
}

<!-- Plant Detail Modal -->
@if (showPlantDetail && selectedPlant != null)
{
    <div class="purchase-modal-overlay" @onclick="ClosePlantDetail">
        <div class="purchase-modal plant-detail-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>ðŸŒ± @selectedPlant.Name</h2>
                <button class="btn-close" @onclick="ClosePlantDetail">Ã—</button>
            </div>

            <div class="modal-body">
                <PlantWidget Plant="@selectedPlant"
                             OnWater="HandleWaterPlantFromModal"
                             OnDelete="HandleDeletePlantFromModal"
                             IsWatering="@isWateringPlant" />
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="ClosePlantDetail">Close</button>
            </div>
        </div>
    </div>
}

@code {
    private Book? selectedBook;
    private bool showQuickTimer;
    private bool showPlantSelector;
    private bool showPlantDetail;
    private int selectedPosition;
    private Guid? draggedPlantId;
    private Guid? draggedBookId;
    private UserPlant? selectedPlant;
    private bool isWateringPlant;

    protected override async Task OnInitializedAsync()
    {
        await ViewModel.LoadCommand.ExecuteAsync(null);
    }

    private void HandleSearch()
    {
        ViewModel.SearchCommand.ExecuteAsync(null);
    }

    private async Task HandleClearFilters()
    {
        ViewModel.ClearFiltersCommand.Execute(null);
        await ViewModel.LoadCommand.ExecuteAsync(null);
    }

    private async Task HandleDeleteBook(Guid bookId)
    {
        // TODO: Add confirmation dialog
        await ViewModel.DeleteBookCommand.ExecuteAsync(bookId);
    }

    private void HandleBookClick(Book book)
    {
        // Navigate directly to book detail page for all books
        NavigateToBookDetail(book.Id);
    }

    private void NavigateToBookDetail(Guid bookId)
    {
        Navigation.NavigateTo($"/books/{bookId}");
    }

    private void NavigateToAddBook()
    {
        Navigation.NavigateTo("/books/new");
    }

    private void HandleCloseQuickTimer()
    {
        showQuickTimer = false;
        selectedBook = null;
    }

    private async Task HandleSessionSaved()
    {
        // Refresh the bookshelf to show updated progress
        await ViewModel.LoadCommand.ExecuteAsync(null);
        showQuickTimer = false;
        selectedBook = null;
    }

    // Plant-specific methods
    private void HandleAddPlant(int position)
    {
        selectedPosition = position;
        showPlantSelector = true;
    }

    private void HandleDragStart(Guid plantId)
    {
        System.Diagnostics.Debug.WriteLine($"Bookshelf: Starting drag for plant {plantId}");
        draggedPlantId = plantId;
        draggedBookId = null; // Clear book drag when dragging plant
    }

    private void HandleDragStartBook(Guid bookId)
    {
        System.Diagnostics.Debug.WriteLine($"Bookshelf: Starting drag for book {bookId}");
        draggedBookId = bookId;
        draggedPlantId = null; // Clear plant drag when dragging book
    }

    private async Task HandleDropOnSlot(int position)
    {
        System.Diagnostics.Debug.WriteLine($"Bookshelf: Drop on slot {position}, PlantId: {draggedPlantId}, BookId: {draggedBookId}");

        if (draggedPlantId.HasValue)
        {
            System.Diagnostics.Debug.WriteLine($"Bookshelf: Moving plant {draggedPlantId.Value} to position {position}");
            await ViewModel.MovePlantToPositionCommand.ExecuteAsync((draggedPlantId.Value, position.ToString()));
            draggedPlantId = null;
        }
        else if (draggedBookId.HasValue)
        {
            System.Diagnostics.Debug.WriteLine($"Bookshelf: Moving book {draggedBookId.Value} to position {position}");
            await ViewModel.MoveBookToPositionCommand.ExecuteAsync((draggedBookId.Value, position.ToString()));
            draggedBookId = null;
        }
    }

    private void HandlePlantClick(UserPlant plant)
    {
        // Show plant detail modal
        selectedPlant = plant;
        showPlantDetail = true;
    }

    private void ClosePlantDetail()
    {
        showPlantDetail = false;
        selectedPlant = null;
    }

    private async Task HandleWaterPlantFromModal()
    {
        if (selectedPlant == null) return;

        isWateringPlant = true;
        try
        {
            await ViewModel.WaterPlantCommand.ExecuteAsync(selectedPlant.Id);
            // Refresh plant data
            await ViewModel.LoadCommand.ExecuteAsync(null);
        }
        finally
        {
            isWateringPlant = false;
        }
    }

    private async Task HandleDeletePlantFromModal()
    {
        if (selectedPlant == null) return;

        try
        {
            await ViewModel.DeletePlantCommand.ExecuteAsync(selectedPlant.Id);
            // Close modal and refresh
            ClosePlantDetail();
            await ViewModel.LoadCommand.ExecuteAsync(null);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Failed to delete plant: {ex.Message}");
        }
    }

    private async Task HandleRemovePlant(Guid plantId)
    {
        await ViewModel.RemovePlantFromBookshelfCommand.ExecuteAsync(plantId);
    }

    private async Task SelectPlantForPlacement(Guid plantId)
    {
        await ViewModel.PlacePlantInBookshelfCommand.ExecuteAsync((plantId, selectedPosition.ToString()));
        showPlantSelector = false;
    }

    private void ClosePlantSelector()
    {
        showPlantSelector = false;
    }

    private string GetPlantPreviewStyle(UserPlant plant)
    {
        var hash = plant.SpeciesId.GetHashCode();
        var colors = new[]
        {
            ("8B4513", "A0522D"), // Terra cotta
            ("6B4423", "7D5530"), // Clay brown
            ("4A7C59", "5C8E6B"), // Green pot
            ("5D4E6D", "6F5F7F"), // Purple pot
            ("8B7355", "A68968"), // Gold pot
        };

        var colorIndex = Math.Abs(hash) % colors.Length;
        var (dark, light) = colors[colorIndex];

        return $"background: linear-gradient(to bottom, #{light}, #{dark}); padding: 2rem; border-radius: 8px;";
    }

    private string GetPlantStatusIcon(PlantStatus status)
    {
        return status switch
        {
            PlantStatus.Healthy => "ðŸ˜Š",
            PlantStatus.Thirsty => "ðŸ˜°",
            PlantStatus.Wilting => "ðŸ˜µ",
            PlantStatus.Dead => "ðŸ’€",
            _ => "ðŸŒ±"
        };
    }
}

