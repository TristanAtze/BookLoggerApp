@page "/stats"
@using BookLoggerApp.Core.ViewModels
@using BookLoggerApp.Core.Models
@inject StatsViewModel ViewModel

<PageTitle>Stats - BookLogger</PageTitle>

<div class="stats-container">
    <h1>üìä Statistics</h1>

    @if (ViewModel.IsBusy)
    {
        <div class="loading">Loading statistics...</div>
    }
    else if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
    {
        <div class="alert alert-danger">@ViewModel.ErrorMessage</div>
    }
    else
    {
        <!-- Overview Stats -->
        <section class="stats-overview">
            <div class="stats-grid">
                <StatCard Icon="üìö" Title="Total Books Read" Value="@ViewModel.TotalBooksRead" />
                <StatCard Icon="üìÑ" Title="Total Pages" Value="@ViewModel.TotalPagesRead" />
                <StatCard Icon="‚è±Ô∏è" Title="Total Minutes" Value="@FormatMinutes(ViewModel.TotalMinutesRead)" />
                <StatCard Icon="üî•" Title="Current Streak" Value="@($"{ViewModel.CurrentStreak} days")" />
                <StatCard Icon="‚≠ê" Title="Longest Streak" Value="@($"{ViewModel.LongestStreak} days")" />
                <StatCard Icon="üìà" Title="Average Rating" Value="@ViewModel.AverageRating.ToString("F1")" />
            </div>
        </section>

        <!-- Favorite Genre -->
        @if (!string.IsNullOrEmpty(ViewModel.FavoriteGenre))
        {
            <section class="favorite-genre">
                <h2>Favorite Genre</h2>
                <p>@ViewModel.FavoriteGenre</p>
            </section>
        }

        <!-- Genre Breakdown -->
        @if (ViewModel.BooksByGenre.Any())
        {
            <section class="genre-breakdown">
                <h2>Books by Genre</h2>
                <ul class="genre-list">
                    @foreach (var genre in ViewModel.BooksByGenre.OrderByDescending(g => g.Value))
                    {
                        <li>@genre.Key: @genre.Value books</li>
                    }
                </ul>
            </section>
        }

        <!-- Rating Category Averages -->
        @if (ViewModel.CategoryAverages.Any())
        {
            <section class="rating-averages-section">
                <h2>üìä Average Ratings by Category</h2>
                <div class="rating-averages-grid">
                    @foreach (var category in RatingCategoryInfo.GetAllCategories())
                    {
                        var average = ViewModel.CategoryAverages.GetValueOrDefault(category.Category, 0);
                        @if (average > 0)
                        {
                            <div class="rating-average-card">
                                <div class="rating-category-header">
                                    <span class="rating-emoji">@category.Emoji</span>
                                    <span class="rating-name">@category.DisplayName</span>
                                </div>
                                <div class="rating-value">@average.ToString("F1")</div>
                                <div class="rating-stars-display">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <span class="star @(i <= Math.Round(average) ? "filled" : "empty")">‚òÖ</span>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            </section>
        }

        <!-- Top Rated Books -->
        @if (ViewModel.TopRatedBooks?.Any() == true)
        {
            <section class="top-rated-books-section">
                <h2>üèÜ Top Rated Books</h2>

                <!-- Category Filter Buttons -->
                <div class="category-filter-buttons">
                    <button class="btn category-filter-btn @(selectedCategory == null ? "active" : "")"
                            @onclick="() => FilterByCategory(null)">
                        All
                    </button>
                    @foreach (var category in RatingCategoryInfo.GetAllCategories())
                    {
                        <button class="btn category-filter-btn @(selectedCategory == category.Category ? "active" : "")"
                                @onclick="() => FilterByCategory(category.Category)">
                            @category.Emoji @category.DisplayName
                        </button>
                    }
                </div>

                <div class="top-books-list">
                    @{
                        int rank = 1;
                    }
                    @foreach (var bookRating in ViewModel.TopRatedBooks.Take(10))
                    {
                        <div class="top-book-item" @key="bookRating.Book.Id">
                            <div class="book-rank">@rank</div>
                            <div class="book-info">
                                <div class="book-title">@bookRating.Book.Title</div>
                                <div class="book-author">by @bookRating.Book.Author</div>
                            </div>
                            <div class="book-rating-summary">
                                <div class="average-rating">@bookRating.AverageRating.ToString("F1") ‚≠ê</div>
                                <div class="rating-breakdown">
                                    @foreach (var rating in bookRating.Ratings.Where(r => r.Value.HasValue))
                                    {
                                        var categoryInfo = RatingCategoryInfo.GetAllCategories()
                                            .FirstOrDefault(c => c.Category == rating.Key);
                                        @if (categoryInfo != null)
                                        {
                                            <span class="mini-rating">@categoryInfo.Emoji @rating.Value</span>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                        rank++;
                    }
                </div>
            </section>
        }

        <!-- Date Range Filter -->
        <section class="date-filter">
            <h2>Date Range</h2>
            <div class="filter-group">
                <label>From:</label>
                <input type="date" @bind="ViewModel.DateRangeStart" />
            </div>
            <div class="filter-group">
                <label>To:</label>
                <input type="date" @bind="ViewModel.DateRangeEnd" />
            </div>
            <button class="btn btn-primary" @onclick="async () => await ViewModel.RefreshCommand.ExecuteAsync(null)">Refresh</button>
        </section>
    }
</div>

@code {
    private RatingCategory? selectedCategory = null;

    protected override async Task OnInitializedAsync()
    {
        await ViewModel.LoadCommand.ExecuteAsync(null);
    }

    private string FormatMinutes(int minutes)
    {
        if (minutes < 60) return $"{minutes}m";
        var hours = minutes / 60;
        var remainingMinutes = minutes % 60;
        return $"{hours}h {remainingMinutes}m";
    }

    private async Task FilterByCategory(RatingCategory? category)
    {
        selectedCategory = category;
        await ViewModel.FilterTopBooksByCategoryAsync(category);
        StateHasChanged();
    }
}

