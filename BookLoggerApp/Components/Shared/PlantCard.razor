@using BookLoggerApp.Core.Models
@using BookLoggerApp.Core.Enums

<div class="plant-card @(IsInBookshelf ? "in-bookshelf" : "")"
     draggable="@(IsDraggable ? "true" : "false")"
     @onclick="HandleClick"
     @ondragstart="HandleDragStartInternal"
     @ondragend="HandleDragEnd">
    <div class="plant-pot-wrapper">
        <!-- Plant Image -->
        <img src="@Plant.Species.ImagePath" alt="@Plant.Species.Name" class="plant-card-image" draggable="false" />

        <div class="plant-status-badge status-@Plant.Status.ToString().ToLower()">
            @GetStatusIcon()
        </div>
    </div>
    <div class="plant-card-name">
        <span class="plant-name-small">@Plant.Name</span>
    </div>
    @if (ShowActions)
    {
        <div class="plant-card-actions">
            <button class="btn-icon" @onclick:stopPropagation="true" @onclick="HandleRemove" title="Remove from Bookshelf">
                üóëÔ∏è
            </button>
        </div>
    }
</div>

@code {
    [Parameter] public UserPlant Plant { get; set; } = null!;
    [Parameter] public EventCallback OnClick { get; set; }
    [Parameter] public EventCallback OnRemove { get; set; }
    [Parameter] public EventCallback OnDragStart { get; set; }
    [Parameter] public bool IsInBookshelf { get; set; }
    [Parameter] public bool ShowProgress { get; set; } = true;
    [Parameter] public bool ShowActions { get; set; } = true;
    [Parameter] public bool IsDraggable { get; set; } = false;

    private bool _isDragging = false;

    private string GetStatusIcon()
    {
        return Plant.Status switch
        {
            PlantStatus.Healthy => "üòä",
            PlantStatus.Thirsty => "üò∞",
            PlantStatus.Wilting => "üòµ",
            PlantStatus.Dead => "üíÄ",
            _ => "üå±"
        };
    }

    private async Task HandleClick()
    {
        // Don't trigger click if we were dragging
        if (_isDragging)
        {
            _isDragging = false;
            return;
        }
        await OnClick.InvokeAsync();
    }

    private async Task HandleDragStartInternal()
    {
        if (!IsDraggable) return;

        _isDragging = true;
        await OnDragStart.InvokeAsync();
    }

    private void HandleDragEnd()
    {
        // Reset dragging flag after a short delay to prevent click
        _ = Task.Run(async () =>
        {
            await Task.Delay(100);
            _isDragging = false;
        });
    }

    private async Task HandleRemove()
    {
        await OnRemove.InvokeAsync();
    }
}
