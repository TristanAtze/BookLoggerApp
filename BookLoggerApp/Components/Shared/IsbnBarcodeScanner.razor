@using ZXing.Net.Maui
@using ZXing.Net.Maui.Controls
@implements IDisposable

@if (IsVisible)
{
    <div class="barcode-scanner-overlay" @onclick="HandleOverlayClick">
        <div class="barcode-scanner-container" @onclick:stopPropagation="true">
            <!-- Header -->
            <div class="barcode-scanner-header">
                <h3>ðŸ“· Scan ISBN Barcode</h3>
                <button class="btn-close-scanner" @onclick="HandleClose">âœ•</button>
            </div>

            <!-- Instructions -->
            <div class="scanner-instructions">
                <p>Position the book's barcode within the frame</p>
                <p class="scanner-hint">Supports EAN-13, EAN-8, and UPC barcodes</p>
            </div>

            <!-- Camera View -->
            <div class="camera-view-container">
                <CameraBarcodeReaderView
                    @ref="_cameraBarcodeReaderView"
                    BarcodeDetected="OnBarcodeDetected"
                    Options="@_options"
                    CameraLocation="CameraLocation.Rear"
                    TorchOn="@_torchOn"
                    VibrationOnDetected="true">
                </CameraBarcodeReaderView>

                <!-- Scanning overlay frame -->
                <div class="scan-frame">
                    <div class="scan-corner top-left"></div>
                    <div class="scan-corner top-right"></div>
                    <div class="scan-corner bottom-left"></div>
                    <div class="scan-corner bottom-right"></div>
                </div>
            </div>

            <!-- Controls -->
            <div class="scanner-controls">
                <button class="btn btn-secondary" @onclick="ToggleTorch">
                    @(_torchOn ? "ðŸ”¦ Torch Off" : "ðŸ”¦ Torch On")
                </button>
                <button class="btn btn-danger" @onclick="HandleClose">Cancel</button>
            </div>

            @if (!string.IsNullOrEmpty(_statusMessage))
            {
                <div class="scanner-status @(_isError ? "error" : "success")">
                    @_statusMessage
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<string> OnBarcodeScanned { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private CameraBarcodeReaderView? _cameraBarcodeReaderView;
    private BarcodeReaderOptions _options;
    private bool _torchOn = false;
    private string? _statusMessage;
    private bool _isError = false;
    private bool _isProcessing = false;

    public IsbnBarcodeScanner()
    {
        // Configure barcode reader to only scan ISBN-compatible formats
        _options = new BarcodeReaderOptions
        {
            Formats = BarcodeFormats.OneDimensional, // EAN-13, EAN-8, UPC
            AutoRotate = true,
            Multiple = false,
            TryHarder = true,
            TryInverted = true
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && IsVisible && _cameraBarcodeReaderView != null)
        {
            try
            {
                // Request camera permission
                var status = await Permissions.CheckStatusAsync<Permissions.Camera>();
                if (status != PermissionStatus.Granted)
                {
                    status = await Permissions.RequestAsync<Permissions.Camera>();
                }

                if (status != PermissionStatus.Granted)
                {
                    _statusMessage = "Camera permission denied";
                    _isError = true;
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                _statusMessage = $"Error: {ex.Message}";
                _isError = true;
                StateHasChanged();
            }
        }
    }

    private async void OnBarcodeDetected(BarcodeDetectionEventArgs e)
    {
        if (_isProcessing) return;

        _isProcessing = true;

        try
        {
            var barcode = e.Results?.FirstOrDefault();
            if (barcode != null && !string.IsNullOrEmpty(barcode.Value))
            {
                var isbn = barcode.Value;

                // Validate that it looks like an ISBN
                if (IsValidIsbnFormat(isbn))
                {
                    _statusMessage = $"âœ“ Scanned: {isbn}";
                    _isError = false;
                    StateHasChanged();

                    // Wait a moment to show the success message
                    await Task.Delay(500);

                    // Notify parent component
                    await OnBarcodeScanned.InvokeAsync(isbn);
                    await HandleClose();
                }
                else
                {
                    _statusMessage = "Invalid ISBN format. Please try again.";
                    _isError = true;
                    StateHasChanged();

                    // Allow scanning again after 2 seconds
                    await Task.Delay(2000);
                    _isProcessing = false;
                }
            }
        }
        catch (Exception ex)
        {
            _statusMessage = $"Error: {ex.Message}";
            _isError = true;
            StateHasChanged();
            await Task.Delay(2000);
            _isProcessing = false;
        }
    }

    private bool IsValidIsbnFormat(string barcode)
    {
        // Remove any dashes or spaces
        var cleaned = barcode.Replace("-", "").Replace(" ", "");

        // ISBN-10 or ISBN-13 (10 or 13 digits)
        return cleaned.Length == 10 || cleaned.Length == 13;
    }

    private void ToggleTorch()
    {
        _torchOn = !_torchOn;
    }

    private async Task HandleClose()
    {
        _statusMessage = null;
        _isError = false;
        _isProcessing = false;
        await OnClose.InvokeAsync();
    }

    private void HandleOverlayClick()
    {
        // Close when clicking outside the scanner
        _ = HandleClose();
    }

    public void Dispose()
    {
        _cameraBarcodeReaderView?.Dispose();
    }
}
