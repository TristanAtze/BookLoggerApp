@implements IAsyncDisposable
@inject IJSRuntime JSRuntime

@if (IsVisible)
{
    <div class="barcode-scanner-overlay" @onclick="HandleOverlayClick">
        <div class="barcode-scanner-container" @onclick:stopPropagation="true">
            <!-- Header -->
            <div class="barcode-scanner-header">
                <h3>ðŸ“· Scan ISBN Barcode</h3>
                <button class="btn-close-scanner" @onclick="HandleClose">âœ•</button>
            </div>

            <!-- Instructions -->
            <div class="scanner-instructions">
                <p>Position the book's barcode within the frame</p>
                <p class="scanner-hint">Supports EAN-13, EAN-8, and UPC barcodes</p>
            </div>

            <!-- Camera View -->
            <div class="camera-view-container">
                <video id="barcode-scanner-video" autoplay playsinline></video>

                <!-- Scanning overlay frame -->
                <div class="scan-frame">
                    <div class="scan-corner top-left"></div>
                    <div class="scan-corner top-right"></div>
                    <div class="scan-corner bottom-left"></div>
                    <div class="scan-corner bottom-right"></div>
                </div>
            </div>

            <!-- Controls -->
            <div class="scanner-controls">
                <button class="btn btn-secondary" @onclick="ToggleTorch">
                    @(_torchOn ? "ðŸ”¦ Torch Off" : "ðŸ”¦ Torch On")
                </button>
                <button class="btn btn-danger" @onclick="HandleClose">Cancel</button>
            </div>

            @if (!string.IsNullOrEmpty(_statusMessage))
            {
                <div class="scanner-status @(_isError ? "error" : "success")">
                    @_statusMessage
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<string> OnBarcodeScanned { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private DotNetObjectReference<IsbnBarcodeScanner>? _objRef;
    private bool _torchOn = false;
    private string? _statusMessage;
    private bool _isError = false;
    private bool _isInitialized = false;
    private bool _shouldInitialize = false;

    protected override void OnParametersSet()
    {
        if (IsVisible && !_isInitialized)
        {
            _shouldInitialize = true;
        }
        else if (!IsVisible && _isInitialized)
        {
            _ = StopScanner();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_shouldInitialize)
        {
            _shouldInitialize = false;
            // Small delay to ensure DOM is fully ready
            await Task.Delay(100);
            await InitializeScanner();
        }
    }

    private async Task InitializeScanner()
    {
        try
        {
            _objRef = DotNetObjectReference.Create(this);

            var result = await JSRuntime.InvokeAsync<ScannerResult>(
                "barcodeScanner.initialize",
                _objRef,
                "barcode-scanner-video"
            );

            if (result.Success)
            {
                _isInitialized = true;
                _statusMessage = "Ready to scan";
                _isError = false;
            }
            else
            {
                _statusMessage = result.Error ?? "Failed to initialize camera";
                _isError = true;
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            _statusMessage = $"Error: {ex.Message}";
            _isError = true;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task OnBarcodeDetected(string barcode)
    {
        _statusMessage = $"âœ“ Scanned: {barcode}";
        _isError = false;
        StateHasChanged();

        // Wait a moment to show the success message
        await Task.Delay(500);

        // Notify parent component
        await OnBarcodeScanned.InvokeAsync(barcode);
    }

    [JSInvokable]
    public void OnScanError(string error)
    {
        _statusMessage = $"Error: {error}";
        _isError = true;
        StateHasChanged();
    }

    private async Task ToggleTorch()
    {
        if (!_isInitialized) return;

        try
        {
            _torchOn = !_torchOn;

            var result = await JSRuntime.InvokeAsync<ScannerResult>(
                "barcodeScanner.toggleTorch",
                _torchOn
            );

            if (!result.Success)
            {
                _statusMessage = "Torch not supported on this device";
                _isError = true;
                _torchOn = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            _statusMessage = $"Torch error: {ex.Message}";
            _isError = true;
            _torchOn = false;
            StateHasChanged();
        }
    }

    private async Task StopScanner()
    {
        if (_isInitialized)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("barcodeScanner.stopScanning");
                _isInitialized = false;
            }
            catch
            {
                // Ignore errors during cleanup
            }
        }
    }

    private async Task HandleClose()
    {
        _statusMessage = null;
        _isError = false;
        await StopScanner();
        await OnClose.InvokeAsync();
    }

    private void HandleOverlayClick()
    {
        // Close when clicking outside the scanner
        _ = HandleClose();
    }

    public async ValueTask DisposeAsync()
    {
        await StopScanner();
        _objRef?.Dispose();
    }

    // Helper class for JS interop results
    private class ScannerResult
    {
        public bool Success { get; set; }
        public string? Error { get; set; }
    }
}
