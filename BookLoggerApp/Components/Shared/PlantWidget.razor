@using BookLoggerApp.Core.Models
@using BookLoggerApp.Core.Enums
@using BookLoggerApp.Infrastructure.Services.Helpers

<div class="plant-widget @GetStatusClass()">
    <!-- Plant Visual -->
    <div class="plant-visual">
        <img src="@GetPlantImage()" alt="@Plant.Name" class="plant-image-large" />
        <div class="plant-status-indicator">@GetStatusEmoji()</div>
    </div>

    <!-- Plant Info -->
    <div class="plant-info">
        <h3 class="plant-name">@Plant.Name</h3>
        <p class="plant-species">@Plant.Species.Name</p>

        <!-- Level Badge -->
        <div class="plant-level">
            <span class="level-badge">Level @Plant.CurrentLevel / @Plant.Species.MaxLevel</span>
        </div>

        <!-- XP Progress -->
        <div class="plant-xp">
            <div class="xp-bar">
                <div class="xp-fill" style="width: @GetXpPercentage()%"></div>
            </div>
            <p class="xp-text">
                XP: @Plant.Experience / @GetNextLevelXp() (@GetXpPercentage()%)
            </p>
        </div>

        <!-- Watering Status -->
        <div class="plant-watering">
            <p class="watering-status">@GetWateringStatus()</p>
            @if (Plant.Status != PlantStatus.Dead)
            {
                <button class="btn btn-water"
                        @onclick="() => OnWater.InvokeAsync()"
                        disabled="@(Plant.Status == PlantStatus.Healthy || IsWatering)">
                    @if (IsWatering)
                    {
                        <span>üíß Watering...</span>
                    }
                    else
                    {
                        <span>üíß Water Plant</span>
                    }
                </button>
            }
            else
            {
                <p class="plant-dead-message">üò¢ Your plant has died. It can no longer provide XP boosts.</p>
                @if (OnDelete.HasDelegate)
                {
                    <button class="btn btn-danger" @onclick="() => OnDelete.InvokeAsync()">
                        üóëÔ∏è Delete Dead Plant
                    </button>
                }
            }
        </div>

        <!-- Days Until Water Needed -->
        @if (Plant.Status == PlantStatus.Healthy)
        {
            <p class="water-timer">
                Next water in @GetDaysUntilWater() day(s)
            </p>
        }
    </div>
</div>

@code {
    [Parameter] public UserPlant Plant { get; set; } = null!;
    [Parameter] public EventCallback OnWater { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }
    [Parameter] public bool IsWatering { get; set; }

    private string GetPlantImage()
    {
        // In the future, could be level-dependent (different sprites for different levels)
        return Plant.Species.ImagePath;
    }

    private string GetStatusClass()
    {
        return $"status-{Plant.Status.ToString().ToLower()}";
    }

    private string GetStatusEmoji()
    {
        return Plant.Status switch
        {
            PlantStatus.Healthy => "üòä",
            PlantStatus.Thirsty => "üò∞",
            PlantStatus.Wilting => "üòµ",
            PlantStatus.Dead => "üíÄ",
            _ => ""
        };
    }

    private string GetWateringStatus()
    {
        var daysSince = (DateTime.UtcNow - Plant.LastWatered).TotalDays;
        return Plant.Status switch
        {
            PlantStatus.Healthy => $"Last watered {(int)daysSince} day(s) ago. Doing great! üåø",
            PlantStatus.Thirsty => "‚ö†Ô∏è Needs water soon!",
            PlantStatus.Wilting => "‚ö†Ô∏è‚ö†Ô∏è Needs water urgently!",
            PlantStatus.Dead => "üò¢ Plant has died.",
            _ => ""
        };
    }

    private int GetNextLevelXp()
    {
        if (Plant.CurrentLevel >= Plant.Species.MaxLevel)
            return Plant.Experience; // Max level reached

        return PlantGrowthCalculator.GetTotalXpForLevel(Plant.CurrentLevel + 1, Plant.Species.GrowthRate);
    }

    private int GetXpPercentage()
    {
        if (Plant.CurrentLevel >= Plant.Species.MaxLevel)
            return 100; // Max level reached

        return PlantGrowthCalculator.GetXpPercentage(
            Plant.CurrentLevel,
            Plant.Experience,
            Plant.Species.GrowthRate
        );
    }

    private string GetDaysUntilWater()
    {
        var daysUntil = PlantGrowthCalculator.GetDaysUntilWaterNeeded(
            Plant.LastWatered,
            Plant.Species.WaterIntervalDays
        );

        return $"{daysUntil:F1}";
    }
}

