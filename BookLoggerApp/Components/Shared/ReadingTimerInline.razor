@using BookLoggerApp.Core.Models
@using BookLoggerApp.Core.Services.Abstractions
@implements IDisposable
@inject IProgressService ProgressService
@inject IBookService BookService

@if (Book != null)
{
    <div class="reading-timer-inline">
        <!-- Timer Header -->
        <div class="timer-inline-header">
            <h3>üìñ Reading Session</h3>
            @if (!IsRunning && ElapsedTime.TotalSeconds == 0)
            {
                <span class="timer-status-badge ready">Ready to read</span>
            }
            else if (IsRunning)
            {
                <span class="timer-status-badge active">‚óè Active</span>
            }
            else
            {
                <span class="timer-status-badge paused">‚è∏ Paused</span>
            }
        </div>

        <!-- Main Timer Display -->
        <div class="timer-inline-main">
            <div class="timer-display-large">
                <div class="timer-icon">‚è±Ô∏è</div>
                <div class="timer-value-large">@FormatTime(ElapsedTime)</div>
            </div>

            <!-- Controls -->
            <div class="timer-controls-inline">
                @if (!IsRunning && ElapsedTime.TotalSeconds == 0)
                {
                    <button class="btn btn-primary btn-large" @onclick="HandleStart">
                        ‚ñ∂ Start Reading
                    </button>
                }
                else if (IsRunning)
                {
                    <button class="btn btn-secondary btn-large" @onclick="HandlePause">
                        ‚è∏ Pause
                    </button>
                }
                else
                {
                    <button class="btn btn-primary" @onclick="HandleResume">
                        ‚ñ∂ Resume
                    </button>
                    <button class="btn btn-success" @onclick="HandleSave">
                        ‚úì Save Session
                    </button>
                    <button class="btn btn-danger" @onclick="HandleCancel">
                        ‚úï Cancel
                    </button>
                }
            </div>
        </div>

        <!-- Session Details -->
        <div class="timer-inline-details">
            <div class="timer-detail-row">
                <div class="timer-detail-item">
                    <label>Pages Read</label>
                    <div class="pages-input-group-inline">
                        <button class="btn-adjust" @onclick="DecrementPages" disabled="@(PagesRead <= 0 || IsRunning)">-</button>
                        <input type="number"
                               class="pages-input-inline"
                               @bind="PagesRead"
                               @bind:event="oninput"
                               min="0"
                               disabled="@IsRunning"
                               placeholder="0" />
                        <button class="btn-adjust" @onclick="IncrementPages" disabled="@IsRunning">+</button>
                    </div>
                </div>

                @if (ElapsedTime.TotalSeconds > 0)
                {
                    <div class="timer-detail-item">
                        <label>XP to Earn</label>
                        <div class="xp-display-inline">
                            <span class="xp-value">@CalculateXP()</span>
                            <span class="xp-label">XP</span>
                        </div>
                    </div>

                    <div class="timer-detail-item">
                        <label>Minutes</label>
                        <div class="minutes-display">
                            @((int)Math.Ceiling(ElapsedTime.TotalMinutes)) min
                        </div>
                    </div>
                }
            </div>
        </div>

        @if (Book.PageCount.HasValue && PagesRead > 0)
        {
            <div class="timer-progress-info">
                <p class="progress-text">
                    Progress: @Book.CurrentPage ‚Üí @(Book.CurrentPage + PagesRead) / @Book.PageCount
                    (@CalculateNewProgressPercentage()%)
                </p>
            </div>
        }
    </div>
}

@code {
    [Parameter] public Book? Book { get; set; }
    [Parameter] public EventCallback OnSessionSaved { get; set; }

    private DateTime? StartTime { get; set; }
    private TimeSpan ElapsedTime { get; set; } = TimeSpan.Zero;
    private TimeSpan PausedTime { get; set; } = TimeSpan.Zero;
    private bool IsRunning { get; set; }
    private int PagesRead { get; set; }
    private System.Threading.Timer? _timer;

    protected override void OnParametersSet()
    {
        // Reset when book changes
        if (Book != null && !IsRunning)
        {
            ResetTimer();
        }
    }

    private void HandleStart()
    {
        StartTime = DateTime.UtcNow;
        IsRunning = true;
        PausedTime = TimeSpan.Zero;
        ElapsedTime = TimeSpan.Zero;
        StartTimer();
    }

    private void HandlePause()
    {
        IsRunning = false;
        PausedTime = ElapsedTime;
        StopTimer();
    }

    private void HandleResume()
    {
        StartTime = DateTime.UtcNow - PausedTime;
        IsRunning = true;
        StartTimer();
    }

    private async Task HandleSave()
    {
        if (Book == null || ElapsedTime.TotalSeconds == 0) return;

        StopTimer();

        try
        {
            // Save session
            var session = new ReadingSession
            {
                BookId = Book.Id,
                StartedAt = StartTime ?? DateTime.UtcNow,
                EndedAt = DateTime.UtcNow,
                Minutes = (int)Math.Ceiling(ElapsedTime.TotalMinutes),
                PagesRead = PagesRead > 0 ? PagesRead : null,
                XpEarned = CalculateXP()
            };

            await ProgressService.AddSessionAsync(session);

            // Update book progress if pages were read
            if (PagesRead > 0)
            {
                var currentPage = Book.CurrentPage + PagesRead;
                await BookService.UpdateProgressAsync(Book.Id, currentPage);
            }

            // Notify parent
            await OnSessionSaved.InvokeAsync();

            // Reset
            ResetTimer();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Failed to save session: {ex.Message}");
        }
    }

    private void HandleCancel()
    {
        StopTimer();
        ResetTimer();
    }

    private void IncrementPages()
    {
        if (!IsRunning)
        {
            PagesRead++;
        }
    }

    private void DecrementPages()
    {
        if (PagesRead > 0 && !IsRunning)
        {
            PagesRead--;
        }
    }

    private void ResetTimer()
    {
        ElapsedTime = TimeSpan.Zero;
        PausedTime = TimeSpan.Zero;
        StartTime = null;
        IsRunning = false;
        PagesRead = 0;
    }

    private int CalculateXP()
    {
        var minuteXp = (int)ElapsedTime.TotalMinutes;
        var pageXp = PagesRead * 2;
        return minuteXp + pageXp;
    }

    private int CalculateNewProgressPercentage()
    {
        if (Book?.PageCount == null || Book.PageCount == 0) return 0;
        var newPage = Book.CurrentPage + PagesRead;
        return (newPage * 100) / Book.PageCount.Value;
    }

    private string FormatTime(TimeSpan time)
    {
        if (time.TotalHours >= 1)
        {
            return $"{(int)time.TotalHours:D2}:{time.Minutes:D2}:{time.Seconds:D2}";
        }
        return $"{time.Minutes:D2}:{time.Seconds:D2}";
    }

    private void StartTimer()
    {
        _timer?.Dispose();
        _timer = new System.Threading.Timer(_ =>
        {
            if (IsRunning && StartTime.HasValue)
            {
                ElapsedTime = DateTime.UtcNow - StartTime.Value;
                InvokeAsync(StateHasChanged);
            }
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private void StopTimer()
    {
        _timer?.Dispose();
        _timer = null;
    }

    public void Dispose()
    {
        StopTimer();
    }
}
