@using BookLoggerApp.Core.Models
@using BookLoggerApp.Core.Services.Abstractions
@implements IDisposable
@inject IProgressService ProgressService
@inject IBookService BookService

@if (Book != null)
{
    <div class="reading-timer-inline">
        <!-- Timer Header -->
        <div class="timer-inline-header">
            <h3>üìñ Reading Session</h3>
            @if (!IsRunning && ElapsedTime.TotalSeconds == 0)
            {
                <span class="timer-status-badge ready">Ready to read</span>
            }
            else if (IsRunning)
            {
                <span class="timer-status-badge active">‚óè Active</span>
            }
            else
            {
                <span class="timer-status-badge paused">‚è∏ Paused</span>
            }
        </div>

        <!-- Main Timer Display -->
        <div class="timer-inline-main">
            <div class="timer-display-large">
                <div class="timer-icon">‚è±Ô∏è</div>
                <div class="timer-value-large">@FormatTime(ElapsedTime)</div>
            </div>

            <!-- Controls -->
            <div class="timer-controls-inline">
                @if (!IsRunning && ElapsedTime.TotalSeconds == 0)
                {
                    <button class="btn btn-primary btn-large" @onclick="HandleStart">
                        ‚ñ∂ Start Reading
                    </button>
                }
                else if (IsRunning)
                {
                    <button class="btn btn-secondary btn-large" @onclick="HandlePause">
                        ‚è∏ Pause
                    </button>
                }
                else
                {
                    <button class="btn btn-primary" @onclick="HandleResume">
                        ‚ñ∂ Resume
                    </button>
                    <button class="btn btn-success" @onclick="HandleSave">
                        ‚úì Save Session
                    </button>
                    <button class="btn btn-danger" @onclick="HandleCancel">
                        ‚úï Cancel
                    </button>
                }
            </div>
        </div>

        <!-- Session Details - Only show after timer is paused -->
        @if (!IsRunning && ElapsedTime.TotalSeconds > 0)
        {
            <div class="timer-inline-details">
                <div class="timer-detail-row">
                    <div class="timer-detail-item">
                        <label>Current Page</label>
                        <div class="pages-input-group-inline">
                            <button class="btn-adjust" @onclick="DecrementCurrentPage" disabled="@(CurrentPageInput <= Book.CurrentPage)">-</button>
                            <input type="number"
                                   class="pages-input-inline"
                                   @bind="CurrentPageInput"
                                   @bind:event="oninput"
                                   min="@Book.CurrentPage"
                                   max="@(Book.PageCount ?? 9999)"
                                   placeholder="@Book.CurrentPage.ToString()" />
                            <button class="btn-adjust" @onclick="IncrementCurrentPage">+</button>
                        </div>
                        <small class="input-hint">Was on page @Book.CurrentPage</small>
                    </div>

                    <div class="timer-detail-item">
                        <label>Pages Read</label>
                        <div class="pages-display">
                            @CalculatePagesRead() pages
                        </div>
                    </div>

                    <div class="timer-detail-item">
                        <label>XP to Earn</label>
                        <div class="xp-display-inline">
                            <span class="xp-value">@CalculateXP()</span>
                            <span class="xp-label">XP</span>
                        </div>
                    </div>

                    <div class="timer-detail-item">
                        <label>Minutes</label>
                        <div class="minutes-display">
                            @((int)Math.Ceiling(ElapsedTime.TotalMinutes)) min
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (Book.PageCount.HasValue && !IsRunning && ElapsedTime.TotalSeconds > 0 && CalculatePagesRead() > 0)
        {
            <div class="timer-progress-info">
                <p class="progress-text">
                    Progress: @Book.CurrentPage ‚Üí @CurrentPageInput / @Book.PageCount
                    (@CalculateNewProgressPercentage()%)
                </p>
            </div>
        }
    </div>
}

@code {
    [Parameter] public Book? Book { get; set; }
    [Parameter] public EventCallback OnSessionSaved { get; set; }

    private DateTime? StartTime { get; set; }
    private TimeSpan ElapsedTime { get; set; } = TimeSpan.Zero;
    private TimeSpan PausedTime { get; set; } = TimeSpan.Zero;
    private bool IsRunning { get; set; }
    private int CurrentPageInput { get; set; }
    private int PagesRead => CalculatePagesRead();
    private System.Threading.Timer? _timer;

    protected override void OnParametersSet()
    {
        // Reset when book changes or initialize CurrentPageInput
        if (Book != null && !IsRunning)
        {
            if (CurrentPageInput == 0 || CurrentPageInput < Book.CurrentPage)
            {
                CurrentPageInput = Book.CurrentPage;
            }
        }
    }

    private void HandleStart()
    {
        StartTime = DateTime.UtcNow;
        IsRunning = true;
        PausedTime = TimeSpan.Zero;
        ElapsedTime = TimeSpan.Zero;
        StartTimer();
    }

    private void HandlePause()
    {
        IsRunning = false;
        PausedTime = ElapsedTime;
        StopTimer();
    }

    private void HandleResume()
    {
        StartTime = DateTime.UtcNow - PausedTime;
        IsRunning = true;
        StartTimer();
    }

    private async Task HandleSave()
    {
        if (Book == null || ElapsedTime.TotalSeconds == 0) return;

        StopTimer();

        try
        {
            var pagesRead = CalculatePagesRead();

            // Save session
            var session = new ReadingSession
            {
                BookId = Book.Id,
                StartedAt = StartTime ?? DateTime.UtcNow,
                EndedAt = DateTime.UtcNow,
                Minutes = (int)Math.Ceiling(ElapsedTime.TotalMinutes),
                PagesRead = pagesRead > 0 ? pagesRead : null,
                XpEarned = CalculateXP()
            };

            await ProgressService.AddSessionAsync(session);

            // Update book progress if pages were read
            if (pagesRead > 0)
            {
                await BookService.UpdateProgressAsync(Book.Id, CurrentPageInput);
            }

            // Notify parent to refresh
            await OnSessionSaved.InvokeAsync();

            // Reset
            ResetTimer();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Failed to save session: {ex.Message}");
        }
    }

    private void HandleCancel()
    {
        StopTimer();
        ResetTimer();
    }

    private void IncrementCurrentPage()
    {
        if (Book != null && Book.PageCount.HasValue && CurrentPageInput < Book.PageCount.Value)
        {
            CurrentPageInput++;
        }
        else if (Book != null && !Book.PageCount.HasValue)
        {
            CurrentPageInput++;
        }
    }

    private void DecrementCurrentPage()
    {
        if (Book != null && CurrentPageInput > Book.CurrentPage)
        {
            CurrentPageInput--;
        }
    }

    private int CalculatePagesRead()
    {
        if (Book == null) return 0;
        return Math.Max(0, CurrentPageInput - Book.CurrentPage);
    }

    private void ResetTimer()
    {
        ElapsedTime = TimeSpan.Zero;
        PausedTime = TimeSpan.Zero;
        StartTime = null;
        IsRunning = false;
        if (Book != null)
        {
            CurrentPageInput = Book.CurrentPage;
        }
    }

    private int CalculateXP()
    {
        var minuteXp = (int)ElapsedTime.TotalMinutes;
        var pageXp = CalculatePagesRead() * 2;
        return minuteXp + pageXp;
    }

    private int CalculateNewProgressPercentage()
    {
        if (Book?.PageCount == null || Book.PageCount == 0) return 0;
        return (CurrentPageInput * 100) / Book.PageCount.Value;
    }

    private string FormatTime(TimeSpan time)
    {
        if (time.TotalHours >= 1)
        {
            return $"{(int)time.TotalHours:D2}:{time.Minutes:D2}:{time.Seconds:D2}";
        }
        return $"{time.Minutes:D2}:{time.Seconds:D2}";
    }

    private void StartTimer()
    {
        _timer?.Dispose();
        _timer = new System.Threading.Timer(_ =>
        {
            if (IsRunning && StartTime.HasValue)
            {
                ElapsedTime = DateTime.UtcNow - StartTime.Value;
                InvokeAsync(StateHasChanged);
            }
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private void StopTimer()
    {
        _timer?.Dispose();
        _timer = null;
    }

    public void Dispose()
    {
        StopTimer();
    }
}
