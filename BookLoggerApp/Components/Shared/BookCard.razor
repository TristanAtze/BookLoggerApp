<div class="book-card @(IsInBookshelf ? "in-bookshelf-book" : "compact") @(IsInBookshelf ? "" : "")"
     draggable="@(IsDraggable ? "true" : "false")"
     @onclick="HandleClick"
     @ondragstart="HandleDragStartInternal"
     @ondragend="HandleDragEnd">
    <div class="@(IsInBookshelf ? "book-cover-wrapper" : "book-cover-thumbnail")" style="@GetSpineStyle()">
        @if (!string.IsNullOrEmpty(Book.CoverImagePath))
        {
            <img src="@GetCoverImageUrl()"
                 alt="@Book.Title"
                 class="book-cover-image"
                 @ondragstart:preventDefault="true"
                 onerror="this.style.display='none'; console.error('Failed to load image: @GetCoverImageUrl()');" />
        }
    </div>

    @if (IsInBookshelf)
    {
        <!-- Spine view: title and author on the spine -->
        <div class="book-status-badge status-@Book.Status.ToString().ToLower()">
            @GetStatusIcon()
        </div>
        <div class="book-card-body">
            <h3 class="book-title">@Book.Title</h3>
            <p class="book-author">@Book.Author</p>
        </div>
        @if (Book.Status == BookLoggerApp.Core.Models.ReadingStatus.Reading || Book.Status == BookLoggerApp.Core.Models.ReadingStatus.Completed)
        {
            <div class="book-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: @Book.ProgressPercentage%"></div>
                </div>
            </div>
        }
    }
    else
    {
        <!-- Compact card view: horizontal layout -->
        <div class="book-card-content">
            <div class="book-card-header">
                <div class="book-status-badge status-@Book.Status.ToString().ToLower()">
                    @GetStatusIcon()
                </div>
                <button class="btn-icon-compact" @onclick:stopPropagation="true" @onclick="HandleDelete" title="Delete">
                    üóëÔ∏è
                </button>
            </div>
            <h3 class="book-title">@Book.Title</h3>
            <p class="book-author">@Book.Author</p>
            @if (Book.OverallRating.HasValue)
            {
                <div class="book-rating">
                    @for (int i = 1; i <= 5; i++)
                    {
                        <span class="star @(i <= Book.OverallRating.Value ? "filled" : "empty")">‚òÖ</span>
                    }
                </div>
            }
            @if (Book.Status == BookLoggerApp.Core.Models.ReadingStatus.Reading || Book.Status == BookLoggerApp.Core.Models.ReadingStatus.Completed)
            {
                <div class="book-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: @Book.ProgressPercentage%"></div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public BookLoggerApp.Core.Models.Book Book { get; set; } = null!;
    [Parameter] public EventCallback OnClick { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }
    [Parameter] public EventCallback OnQuickTimer { get; set; }
    [Parameter] public EventCallback OnDragStart { get; set; }
    [Parameter] public bool IsInBookshelf { get; set; }
    [Parameter] public bool IsDraggable { get; set; } = false;

    private bool _isDragging = false;

    private string GetCoverImageUrl()
    {
        if (string.IsNullOrEmpty(Book.CoverImagePath))
            return string.Empty;

        // Ensure the path starts with / for wwwroot access
        var path = Book.CoverImagePath.Replace("\\", "/");
        if (!path.StartsWith("/"))
            path = "/" + path;

        return path;
    }

    private string GetSpineStyle()
    {
        // Use custom spine color if set, otherwise generate based on book ID
        var colors = new Dictionary<string, (string dark, string light)>
        {
            { "red", ("8B4513", "A0522D") },
            { "blue", ("2C4A6B", "3A5F7D") },
            { "green", ("3D5A3D", "4A6B4A") },
            { "purple", ("5D4E6D", "6F5F7F") },
            { "brown", ("4A3426", "5C452F") },
            { "gold", ("8B7355", "A68968") },
            { "burgundy", ("6B3240", "7D4450") },
            { "teal", ("2C5F5F", "3A7373") },
            { "navy", ("1C2E4A", "2A3F5F") },
            { "olive", ("4A4A2C", "5C5C3A") }
        };

        string dark, light;

        if (!string.IsNullOrEmpty(Book.SpineColor) && colors.ContainsKey(Book.SpineColor.ToLower()))
        {
            // Use custom color
            (dark, light) = colors[Book.SpineColor.ToLower()];
        }
        else
        {
            // Generate color based on book ID hash
            var colorList = colors.Values.ToArray();
            var hash = Book.Id.GetHashCode();
            var colorIndex = Math.Abs(hash) % colorList.Length;
            (dark, light) = colorList[colorIndex];
        }

        return $"background: linear-gradient(to right, #{dark}, #{light}, #{dark});";
    }

    private string GetStatusIcon()
    {
        return Book.Status switch
        {
            BookLoggerApp.Core.Models.ReadingStatus.Planned => "üìã",
            BookLoggerApp.Core.Models.ReadingStatus.Reading => "üìñ",
            BookLoggerApp.Core.Models.ReadingStatus.Completed => "‚úÖ",
            BookLoggerApp.Core.Models.ReadingStatus.Abandoned => "‚ùå",
            _ => ""
        };
    }

    private async Task HandleClick()
    {
        // Don't trigger click if we were dragging
        if (_isDragging)
        {
            _isDragging = false;
            return;
        }
        await OnClick.InvokeAsync();
    }

    private async Task HandleDragStartInternal(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        if (!IsDraggable) return;

        System.Diagnostics.Debug.WriteLine($"BookCard: Drag started for book {Book.Title}");
        _isDragging = true;
        await OnDragStart.InvokeAsync();
    }

    private void HandleDragEnd(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        System.Diagnostics.Debug.WriteLine($"BookCard: Drag ended for book {Book.Title}");
        // Reset dragging flag after a short delay to prevent click
        _ = Task.Run(async () =>
        {
            await Task.Delay(100);
            _isDragging = false;
        });
    }

    private async Task HandleDelete()
    {
        await OnDelete.InvokeAsync();
    }
}

